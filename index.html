<!DOCTYPE html>
<html>
<head>
    <title>é™„è¿‘åœè»Šå ´è³‡è¨Š</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="liff.config.js"></script>
    <style>
        /* ... existing styles ... */
        .navigation-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #E6000B;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            border-radius: 4px;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .navigation-button:hover {
            background-color: #cc0009;
        }

        .navigation-button img {
            width: 20px;
            height: 20px;
        }

        .info-window {
            padding: 12px;
            max-width: 300px;
        }

        .info-window-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .info-window-header h3 {
            margin: 0;
            padding-right: 8px;
            font-size: 16px;
            font-weight: bold;
        }

        .info-window p {
            margin: 4px 0;
            font-size: 14px;
        }

        .gm-ui-hover-effect {
            top: 0 !important;
            right: 0 !important;
        }

        .gm-style-iw {
            padding: 0 !important;
        }

        .gm-style-iw-d {
            overflow: hidden !important;
        }

        .gm-style-iw-c {
            padding: 0 !important;
        }
        /* ... rest of the styles ... */
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="ä½ æƒ³å»å“ªè£¡ï¼Ÿ">
        <button class="search-button" onclick="handleSearch()">æœå°‹</button>
        <button class="clear-button" onclick="clearSearch()">æ¸…é™¤</button>
    </div>
    <div id="map"></div>
    <button class="list-toggle" onclick="toggleParkingList()">é¡¯ç¤ºæœ€è¿‘åœè»Šå ´</button>
    <button class="my-location-button" onclick="goToMyLocation()" title="å›åˆ°æˆ‘çš„ä½ç½®">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMTIgOGMtMi4yMSAwLTQgMS43OS00IDRzMS43OSA0IDQgNCA0LTEuNzkgNC00LTEuNzktNC00LTR6bTguOTQgM2MtLjQ2LTQuMTctMy43Ny03LjQ4LTcuOTQtNy45NFYxaC0ydjIuMDZDNi44MyAzLjUyIDMuNTIgNi44MyAzLjA2IDExSDFWMTNoMi4wNmMuNDYgNC4xNyAzLjc3IDcuNDggNy45NCA3Ljk0VjIzaDJ2LTIuMDZjNC4xNy0uNDYgNy40OC0zLjc3IDcuOTQtNy45NEgyM3YtMmgtMi4wNnpNMTIgMTljLTMuODcgMC03LTMuMTMtNy03czMuMTMtNyA3LTcgNyAzLjEzIDcgNy0zLjEzIDctNyA3eiIvPjwvc3ZnPg==" alt="å®šä½åœ–æ¨™">
    </button>
    
    <div id="parking-list" class="parking-list">
        <div id="parking-items"></div>
    </div>

    <script>
        // LIFF åˆå§‹åŒ–
        let isLiffInitialized = false;
        let liffProfile = null;

        async function initializeLiff() {
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨ LIFF ç’°å¢ƒä¸­
                if (typeof liff !== 'undefined') {
                    const config = getLiffConfig();
                    
                    await liff.init({ 
                        liffId: config.liffId,
                        withLoginOnExternalBrowser: true // å…è¨±åœ¨å¤–éƒ¨ç€è¦½å™¨ç™»å…¥
                    });
                    isLiffInitialized = true;
                    
                    console.log('LIFF initialized successfully');
                    console.log('LIFF OS:', liff.getOS());
                    console.log('LIFF Version:', liff.getVersion());
                    console.log('Is in client:', liff.isInClient());
                    console.log('Is logged in:', liff.isLoggedIn());
                    
                    // å¦‚æœç”¨æˆ¶å·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶è³‡è¨Š
                    if (liff.isLoggedIn()) {
                        liffProfile = await liff.getProfile();
                        console.log('LIFF user profile:', liffProfile);
                        
                        // å¯é¸ï¼šé¡¯ç¤ºæ­¡è¿è¨Šæ¯
                        showWelcomeMessage(liffProfile.displayName);
                    }
                    
                    // è¨­ç½® LIFF ç‰¹å®šçš„ UI èª¿æ•´
                    adjustUIForLiff();
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                // å³ä½¿ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œapp ä»æ‡‰æ­£å¸¸é‹ä½œ
            }
        }

        // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
        function showWelcomeMessage(displayName) {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.innerHTML = `æ­¡è¿ ${displayName}ï¼`;
            welcomeDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #00B900;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 2000;
                font-size: 14px;
            `;
            document.body.appendChild(welcomeDiv);
            setTimeout(() => welcomeDiv.remove(), 3000);
        }

        // é‡å° LIFF ç’°å¢ƒèª¿æ•´ UI
        function adjustUIForLiff() {
            if (isInLiffApp()) {
                document.body.classList.add('liff-app');
                
                // å¯èƒ½éœ€è¦èª¿æ•´æœå°‹æ¡†çš„ä½ç½®ï¼Œé¿å…èˆ‡ LINE çš„æ¨™é¡Œåˆ—é‡ç–Š
                const searchContainer = document.querySelector('.search-container');
                if (searchContainer) {
                    searchContainer.style.top = '20px'; // ç¨å¾®å‘ä¸‹ç§»å‹•
                }

            }
        }


        // åˆ¤æ–·æ˜¯å¦åœ¨ LIFF ç’°å¢ƒä¸­
        function isInLiffApp() {
            return typeof liff !== 'undefined' && liff.isInClient();
        }

        let map;
        let userMarker;
        let parkingMarkers = [];
        let searchBox;
        let currentInfoWindow = null;
        const MAX_SEARCH_RADIUS = 5000;
        let updateTimeout = null;

        // è§£æè²»ç‡è³‡è¨Š
        function parseParkingFee(payex) {
            if (!payex) return '$0';
            
            // å˜—è©¦åŒ¹é… "XXå…ƒ/æ™‚" æˆ– "æ¯å°æ™‚XXå…ƒ" çš„æ¨¡å¼
            const hourlyFeeMatch = payex.match(/(\d+)å…ƒ\/(å°)?æ™‚|æ¯å°æ™‚(\d+)å…ƒ/);
            if (hourlyFeeMatch) {
                const fee = hourlyFeeMatch[1] || hourlyFeeMatch[3];
                return `$${fee}`;
            }
            
            return '$0';
        }

        // è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢ï¼ˆä½¿ç”¨ Haversine å…¬å¼ï¼‰
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // TWD97 to WGS84 åº§æ¨™è½‰æ›
        function twd97_to_wgs84(x, y) {
            const a = 6378137.0;
            const b = 6356752.314245;
            const lng0 = 121 * Math.PI / 180;
            const k0 = 0.9999;
            const dx = 250000;
            const dy = 0;
            const e = Math.sqrt((a * a - b * b) / (a * a));

            x = parseFloat(x) - dx;
            y = parseFloat(y) - dy;

            // Calculate the meridian distance
            let M = y / k0;

            // Calculate footprint latitude
            let mu = M / (a * (1.0 - Math.pow(e, 2) / 4.0 - 3 * Math.pow(e, 4) / 64.0 - 5 * Math.pow(e, 6) / 256.0));
            let e1 = (1.0 - Math.sqrt(1.0 - Math.pow(e, 2))) / (1.0 + Math.sqrt(1.0 - Math.pow(e, 2)));

            let J1 = (3 * e1 / 2 - 27 * Math.pow(e1, 3) / 32.0);
            let J2 = (21 * Math.pow(e1, 2) / 16 - 55 * Math.pow(e1, 4) / 32.0);
            let J3 = (151 * Math.pow(e1, 3) / 96.0);
            let J4 = (1097 * Math.pow(e1, 4) / 512.0);

            let fp = mu + J1 * Math.sin(2 * mu) + J2 * Math.sin(4 * mu) + J3 * Math.sin(6 * mu) + J4 * Math.sin(8 * mu);

            // Calculate latitude and longitude
            let e2 = Math.pow((e * a / b), 2);
            let C1 = Math.pow(e2 * Math.cos(fp), 2);
            let T1 = Math.pow(Math.tan(fp), 2);
            let R1 = a * (1 - Math.pow(e, 2)) / Math.pow((1 - Math.pow(e, 2) * Math.pow(Math.sin(fp), 2)), (3.0 / 2.0));
            let N1 = a / Math.sqrt(1 - Math.pow(e, 2) * Math.pow(Math.sin(fp), 2));

            let D = x / (N1 * k0);

            // è¨ˆç®—ç·¯åº¦
            let Q1 = N1 * Math.tan(fp) / R1;
            let Q2 = (Math.pow(D, 2) / 2.0);
            let Q3 = (5 + 3 * T1 + 10 * C1 - 4 * Math.pow(C1, 2) - 9 * e2) * Math.pow(D, 4) / 24.0;
            let Q4 = (61 + 90 * T1 + 298 * C1 + 45 * Math.pow(T1, 2) - 3 * Math.pow(C1, 2) - 252 * e2) * Math.pow(D, 6) / 720.0;
            let lat = fp - Q1 * (Q2 - Q3 + Q4);

            // è¨ˆç®—ç¶“åº¦
            let Q5 = D;
            let Q6 = (1 + 2 * T1 + C1) * Math.pow(D, 3) / 6;
            let Q7 = (5 - 2 * C1 + 28 * T1 - 3 * Math.pow(C1, 2) + 8 * e2 + 24 * Math.pow(T1, 2)) * Math.pow(D, 5) / 120.0;
            let lng = lng0 + (Q5 - Q6 + Q7) / Math.cos(fp);

            // è½‰æ›ç‚ºåº¦
            lat = (lat * 180) / Math.PI;
            lng = (lng * 180) / Math.PI;

            return { lat, lng };
        }

        // æª¢æŸ¥åº§æ¨™æ˜¯å¦åœ¨å°åŒ—å¸‚ç¯„åœå…§
        function isCoordinateInTaipei(lat, lng) {
            // å°åŒ—å¸‚çš„å¤§è‡´ç¯„åœ
            const TAIPEI_BOUNDS = {
                minLat: 24.95,
                maxLat: 25.21,
                minLng: 121.45,
                maxLng: 121.67
            };
            
            return lat >= TAIPEI_BOUNDS.minLat && 
                   lat <= TAIPEI_BOUNDS.maxLat && 
                   lng >= TAIPEI_BOUNDS.minLng && 
                   lng <= TAIPEI_BOUNDS.maxLng;
        }

        // ç²å–åœè»Šå ´åº§æ¨™
        function getParkingLotCoordinates(parkingLot) {
            // å„ªå…ˆä½¿ç”¨ TWD97 åº§æ¨™
            if (parkingLot.tw97x && parkingLot.tw97y) {
                return twd97_to_wgs84(parkingLot.tw97x, parkingLot.tw97y);
            }
            
            // å¦‚æœæ²’æœ‰ TWD97 åº§æ¨™ï¼Œæ‰ä½¿ç”¨å…¥å£åº§æ¨™
            if (parkingLot.EntranceCoord?.EntrancecoordInfo?.[0]) {
                const entranceInfo = parkingLot.EntranceCoord.EntrancecoordInfo[0];
                const xcod = parseFloat(entranceInfo.Xcod);
                const ycod = parseFloat(entranceInfo.Ycod);
                
                // é è¨­ Xcod æ˜¯ç¶“åº¦ï¼ŒYcod æ˜¯ç·¯åº¦
                let coords = {
                    lat: ycod,
                    lng: xcod
                };
                
                // æª¢æŸ¥åº§æ¨™æ˜¯å¦åœ¨å°åŒ—å¸‚ç¯„åœå…§
                if (!isCoordinateInTaipei(coords.lat, coords.lng)) {
                    // å¦‚æœåº§æ¨™ä¸åœ¨å°åŒ—å¸‚ç¯„åœå…§ï¼Œå˜—è©¦äº¤æ›ç¶“ç·¯åº¦
                    coords = {
                        lat: xcod,
                        lng: ycod
                    };
                    
                    // å¦‚æœäº¤æ›å¾Œé‚„æ˜¯ä¸åœ¨å°åŒ—å¸‚ç¯„åœå…§ï¼Œé€™å€‹å…¥å£åº§æ¨™å¯èƒ½æœ‰å•é¡Œ
                    if (!isCoordinateInTaipei(coords.lat, coords.lng)) {
                        return null;
                    }
                }
                
                return coords;
            }
            
            return null;
        }

        // é–‹å•Ÿå°èˆª
        function startNavigation(lat, lng, name) {
            const destination = `${lat},${lng}`;
            
            // å¦‚æœåœ¨ LIFF ç’°å¢ƒä¸­ï¼Œä½¿ç”¨ LIFF æ‰“é–‹å¤–éƒ¨ç€è¦½å™¨
            if (isInLiffApp()) {
                const webUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
                
                try {
                    // ä½¿ç”¨ LIFF æ‰“é–‹å¤–éƒ¨ç€è¦½å™¨
                    liff.openWindow({
                        url: webUrl,
                        external: true
                    });
                } catch (error) {
                    console.error('LIFF openWindow failed:', error);
                    // å¦‚æœ LIFF å¤±æ•—ï¼Œå›é€€åˆ°å‚³çµ±æ–¹æ³•
                    window.open(webUrl, '_blank');
                }
                return;
            }
            
            // æª¢æ¸¬è¨­å‚™é¡å‹
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // iOS è¨­å‚™ï¼šä½¿ç”¨ comgooglemaps:// scheme
                const iosUrl = `comgooglemaps://?daddr=${destination}&directionsmode=driving`;
                const webUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
                
                // å˜—è©¦æ‰“é–‹ Google Maps App
                window.location.href = iosUrl;
                
                // å¦‚æœ 2 ç§’å¾Œé‚„åœ¨åŒä¸€é é¢ï¼Œèªªæ˜æ²’æœ‰å®‰è£ Google Mapsï¼Œå‰‡æ‰“é–‹ç¶²é ç‰ˆ
                setTimeout(() => {
                    if (document.hidden !== true) {
                        window.location.href = webUrl;
                    }
                }, 2000);
            } else if (/Android/i.test(navigator.userAgent)) {
                // Android è¨­å‚™ï¼šä½¿ç”¨ google.navigation: scheme
                const androidUrl = `google.navigation:q=${destination}&mode=d`;
                const webUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
                
                // å˜—è©¦æ‰“é–‹ Google Maps App
                window.location.href = androidUrl;
                
                // å¦‚æœ 2 ç§’å¾Œé‚„åœ¨åŒä¸€é é¢ï¼Œèªªæ˜æ²’æœ‰å®‰è£ Google Mapsï¼Œå‰‡æ‰“é–‹ç¶²é ç‰ˆ
                setTimeout(() => {
                    if (document.hidden !== true) {
                        window.location.href = webUrl;
                    }
                }, 2000);
            } else {
                // æ¡Œé¢è¨­å‚™ï¼šåœ¨æ–°çª—å£æ‰“é–‹ç¶²é ç‰ˆåœ°åœ–
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`, '_blank');
            }
        }

        // æ›´æ–°åœè»Šå ´è³‡è¨Šè¦–çª—å…§å®¹
        function createInfoWindow(parkingLot, availability) {
            const availableSpaces = availability ? Math.max(0, availability.availablecar) : 0;
            const status = availableSpaces > 0 ? 'å°šæœ‰ç©ºä½' : 'å·²æ»¿';
            const statusClass = availableSpaces > 0 ? 'available' : 'full';
            const coordinates = getParkingLotCoordinates(parkingLot);
            
            const content = document.createElement('div');
            content.className = 'info-window';

            // é˜²æ­¢å°èˆªæŒ‰éˆ•ç­‰åŠŸèƒ½æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶å†’æ³¡åˆ°åœ°åœ–
            content.addEventListener('click', (e) => {
                // åªåœ¨é»æ“ŠæŒ‰éˆ•æ™‚é˜»æ­¢å†’æ³¡ï¼Œå…¶ä»–åœ°æ–¹å…è¨±å†’æ³¡åˆ°åœ°åœ–
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    e.stopPropagation();
                }
            });            content.innerHTML = `
                <div class="info-window-header">
                    <h3>${parkingLot.name}</h3>
                </div>
                <p>åœ°å€ï¼š${parkingLot.address}</p>
                <p>ç¸½è»Šä½ï¼š${parkingLot.totalcar} å€‹</p>
                <p>å‰©é¤˜è»Šä½ï¼š<span class="${statusClass}">${availableSpaces}</span></p>
                <p>æ”¶è²»ï¼š${parseParkingFee(parkingLot.payex)}</p>
                <p>ç‡Ÿæ¥­æ™‚é–“ï¼š${parkingLot.serviceTime || '24å°æ™‚'}</p>
                ${coordinates ? `<button class="navigation-button">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMjEuNzEgMTEuMjlsLTktOS4wNzJjLS4zOS0uMzktMS4wMi0uMzktMS40MSAwbC05IDkuMDcyYy0uMzkuMzktLjM5IDEuMDIgMCAxLjQxbDkgOS4wNzFjLjM5LjM5IDEuMDIuMzkgMS40MSAwbDktOS4wNzFjLjM5LS4zOS4zOS0xLjAyIDAtMS40MXpNMTQgMTQuNThWMTJoLTR2M0g4di02aDZ2LTIuNThsNC41OSA0LjU5TDE0IDE0LjU4eiIvPjwvc3ZnPg==" alt="å°èˆªåœ–æ¨™">
                    é–‹å§‹å°èˆª
                </button>` : ''}
            `;

            // æ·»åŠ å°èˆªæŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (coordinates) {
                const navButton = content.querySelector('.navigation-button');
                if (navButton) {
                    navButton.addEventListener('click', () => startNavigation(coordinates.lat, coordinates.lng, parkingLot.name));
                }
            }

            return content;
        }

        // æ›´æ–°åœè»Šå ´åˆ—è¡¨
        function updateParkingList(nearbyParkingLots) {
            const listContainer = document.getElementById('parking-items');
            listContainer.innerHTML = '';

            // åªé¡¯ç¤ºæœ€è¿‘çš„3å€‹åœè»Šå ´
            nearbyParkingLots.slice(0, 3).forEach(lot => {
                const availableSpaces = lot.availability ? Math.max(0, lot.availability.availablecar) : 0;
                const statusClass = availableSpaces > 0 ? 'available' : 'full';
                
                const item = document.createElement('div');
                item.className = 'parking-item';
                item.innerHTML = `
                    <h3>${lot.parkingLot.name}</h3>
                    <p>åœ°å€ï¼š${lot.parkingLot.address}</p>
                    <p>æ”¶è²»ï¼š${parseParkingFee(lot.parkingLot.payex)}</p>
                    <p>å‰©é¤˜è»Šä½ï¼š<span class="${statusClass}">${availableSpaces}</span></p>
                    <p>è·é›¢ï¼š${Math.round(lot.distance)}å…¬å°º</p>
                `;
                
                item.addEventListener('click', () => {
                    const coordinates = getParkingLotCoordinates(lot.parkingLot);
                    if (coordinates) {
                        map.setCenter(coordinates);
                        map.setZoom(18);
                    }
                });
                
                listContainer.appendChild(item);
            });
        }

        function toggleParkingList() {
            const list = document.getElementById('parking-list');
            list.classList.toggle('open');
            const button = document.querySelector('.list-toggle');
            button.textContent = list.classList.contains('open') ? 'éš±è—åœè»Šå ´åˆ—è¡¨' : 'é¡¯ç¤ºæœ€è¿‘åœè»Šå ´';
        }

        // è¨ˆç®—æœ€ä½³ç¸®æ”¾ç´šåˆ¥å’Œæœå°‹åŠå¾‘
        function calculateOptimalZoomAndRadius(position, parkingLots, isUserZoom = false) {
            const userLat = position.coords ? position.coords.latitude : position.lat;
            const userLng = position.coords ? position.coords.longitude : position.lng;
            const currentZoom = map.getZoom();
            
            // æ”¹é€²æœå°‹åŠå¾‘è¨ˆç®—é‚è¼¯ï¼Œæ ¹æ“šç¸®æ”¾ç´šåˆ¥èª¿æ•´
            let baseRadius;
            let maxParkingLots;
            if (currentZoom <= 12) {
                baseRadius = 3000;
                maxParkingLots = 10;
            } else if (currentZoom <= 14) {
                baseRadius = 2000;
                maxParkingLots = 15;
            } else if (currentZoom <= 16) {
                baseRadius = 1000;
                maxParkingLots = 20;
            } else {
                baseRadius = 500;
                maxParkingLots = 25;
            }

            // ç²å–æ‰€æœ‰åœ¨ç¯„åœå…§çš„åœè»Šå ´ä¸¦è¨ˆç®—è·é›¢
            let candidateLots = parkingLots.map(lot => {
                const coordinates = getParkingLotCoordinates(lot);
                if (!coordinates) return null;
                
                const distance = getDistance(userLat, userLng, coordinates.lat, coordinates.lng);
                
                return {
                    lot,
                    distance,
                    coordinates
                };
            }).filter(item => item !== null);

            // é¸æ“‡è·é›¢æœ€è¿‘çš„åœè»Šå ´
            let nearbyLots = candidateLots
                .filter(item => item.distance <= baseRadius)
                .sort((a, b) => a.distance - b.distance)
                .slice(0, maxParkingLots);

            // å¦‚æœå®Œå…¨æ‰¾ä¸åˆ°åœè»Šå ´ï¼Œé€æ­¥å¢åŠ æœå°‹åŠå¾‘
            if (nearbyLots.length === 0) {
                let currentRadius = baseRadius;
                while (currentRadius <= MAX_SEARCH_RADIUS && nearbyLots.length === 0) {
                    currentRadius += 500;
                    nearbyLots = candidateLots
                        .filter(item => item.distance <= currentRadius)
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, Math.min(maxParkingLots, 10)); // ç·Šæ€¥æƒ…æ³ä¸‹æœ€å¤šé¡¯ç¤º10å€‹
                }
            }

            return {
                zoom: currentZoom,
                radius: baseRadius,
                nearbyLots: nearbyLots.map(item => item.lot)
            };
        }

        // é˜²æŠ–å‡½æ•¸
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(updateTimeout);
                    func(...args);
                };
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(later, wait);
            };
        }

        // æ–°å¢ï¼šåªç²å–å¯ç”¨æ€§æ•¸æ“šçš„å‡½æ•¸
        async function fetchAvailabilityData() {
            try {
                const availResponse = await fetch('https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_allavailable.json');
                const availData = await availResponse.json();
                return availData;
            } catch (error) {
                console.error('Error fetching availability data:', error);
                return null;
            }
        }

        // æ–°å¢ï¼šæ›´æ–°æ¨™è¨˜å¯ç”¨æ€§çš„å‡½æ•¸
        async function updateMarkersAvailability() {
            const availData = await fetchAvailabilityData();
            if (!availData) return;

            // å»ºç«‹å¯ç”¨æ€§æŸ¥è©¢è¡¨
            const availabilityMap = {};
            availData.data.park.forEach(park => {
                availabilityMap[park.id] = park;
            });

            // æ›´æ–°æ¯å€‹ç¾æœ‰æ¨™è¨˜
            parkingMarkers.forEach(marker => {
                const parkingLot = marker.parkingLot;
                const availability = availabilityMap[parkingLot.id];
                const hasSpaces = availability && availability.availablecar > 0;

                // æ›´æ–°æ¨™è¨˜åœ–æ¨™
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: hasSpaces ? '#4CAF50' : '#f44336',
                    fillOpacity: 0.9,
                    strokeWeight: 2,
                    strokeColor: '#ffffff',
                    scale: 20
                });

                // å¦‚æœè³‡è¨Šè¦–çª—æ˜¯æ‰“é–‹çš„ï¼Œæ›´æ–°å…¶å…§å®¹
                if (currentInfoWindow && currentInfoWindow.anchor === marker) {
                    currentInfoWindow.setContent(createInfoWindow(parkingLot, availability));
                }
            });

            // å¦‚æœåœè»Šå ´åˆ—è¡¨æ˜¯å¯è¦‹çš„ï¼Œæ›´æ–°åˆ—è¡¨
            if (document.getElementById('parking-list').classList.contains('open')) {
                const center = map.getCenter();
                const position = {
                    lat: center.lat(),
                    lng: center.lng()
                };
                updateNearbyParking(position, false);
            }
        }

        // ä¿®æ”¹ï¼šæ›´æ–°é™„è¿‘åœè»Šå ´å‡½æ•¸
        async function updateNearbyParking(position, isUserZoom = false) {
            // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
            let loadingIndicator = document.getElementById('parking-loading');
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'parking-loading';
                loadingIndicator.innerHTML = 'æ­£åœ¨è¼‰å…¥åœè»Šå ´è³‡è¨Š...';
                loadingIndicator.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(76, 175, 80, 0.9);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 1000;
                    font-size: 14px;
                `;
                document.body.appendChild(loadingIndicator);
            }

            try {
                const descResponse = await fetch('https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_alldesc.json');
                const descData = await descResponse.json();
                
                const availResponse = await fetch('https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_allavailable.json');
                const availData = await availResponse.json();

                const userLat = position.coords ? position.coords.latitude : position.lat;
                const userLng = position.coords ? position.coords.longitude : position.lng;

                const { zoom, radius, nearbyLots } = calculateOptimalZoomAndRadius(position, descData.data.park, isUserZoom);

                // ç§»é™¤è¼‰å…¥æŒ‡ç¤ºå™¨
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }

                // åªåœ¨éç”¨æˆ¶ç¸®æ”¾ä¸”æ‰¾ä¸åˆ°åœè»Šå ´æ™‚èª¿æ•´ç¸®æ”¾ç´šåˆ¥
                if (!isUserZoom && nearbyLots.length === 0) {
                    map.setZoom(Math.max(map.getZoom() - 1, 11));
                    return; // ç¸®æ”¾å¾Œæœƒè§¸ç™¼æ–°çš„æ›´æ–°ï¼Œæ‰€ä»¥é€™è£¡ç›´æ¥è¿”å›
                }

                const availabilityMap = {};
                availData.data.park.forEach(park => {
                    availabilityMap[park.id] = park;
                });

                // æ¸…é™¤æ‰€æœ‰ç¾æœ‰çš„åœè»Šå ´æ¨™è¨˜
                parkingMarkers.forEach(marker => marker.setMap(null));
                parkingMarkers = [];

                const nearbyParkingLots = [];

                nearbyLots.forEach(parkingLot => {
                    const coordinates = getParkingLotCoordinates(parkingLot);
                    if (!coordinates) return;
                    
                    const distance = getDistance(userLat, userLng, coordinates.lat, coordinates.lng);
                    
                    const availability = availabilityMap[parkingLot.id];
                    const hasSpaces = availability && availability.availablecar > 0;

                    // ç‚ºæ¯å€‹åœè»Šå ´å‰µå»ºæ¨™è¨˜
                    const marker = new google.maps.Marker({
                        position: coordinates,
                        map: map,
                        title: parkingLot.name,
                        label: {
                            text: parseParkingFee(parkingLot.payex),
                            color: "white",
                            fontSize: "16px",
                            fontWeight: "bold"
                        },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: hasSpaces ? '#4CAF50' : '#f44336',
                            fillOpacity: 0.9,
                            strokeWeight: 2,
                            strokeColor: '#ffffff',
                            scale: 20
                        }
                    });

                    marker.parkingLot = parkingLot;

                    const infoWindow = new google.maps.InfoWindow({
                        content: createInfoWindow(parkingLot, availability),
                        maxWidth: 300,
                        pixelOffset: new google.maps.Size(0, -10)
                    });

                    marker.addListener('click', (e) => {
                        e.stop();
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    });

                    parkingMarkers.push(marker);

                    nearbyParkingLots.push({
                        parkingLot,
                        availability,
                        distance,
                        position: coordinates
                    });
                });

                nearbyParkingLots.sort((a, b) => a.distance - b.distance);
                updateParkingList(nearbyParkingLots);

                // åªåœ¨çœŸçš„æ‰¾ä¸åˆ°åœè»Šå ´æ™‚æ‰é¡¯ç¤ºæç¤º
                if (nearbyParkingLots.length === 0 && radius >= MAX_SEARCH_RADIUS) {
                    alert('é™„è¿‘æ²’æœ‰åœè»Šå ´ï¼Œå·²æ“´å¤§æœå°‹ç¯„åœ');
                }
            } catch (error) {
                // ç§»é™¤è¼‰å…¥æŒ‡ç¤ºå™¨
                const loadingIndicator = document.getElementById('parking-loading');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                console.error('Error fetching parking data:', error);
            }
        }

        function goToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        userMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "ä½ åœ¨é€™è£¡ï¼",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 12
                            }
                        });

                        map.setCenter(pos);
                        map.setZoom(17);

                        updateNearbyParking(position, false);
                    },
                    (error) => {
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                handleLocationError({ code: 'BROWSER_NOT_SUPPORTED' });
            }
        }

        function handleSearch() {
            const input = document.getElementById('search-input');
            const places = searchBox.getPlaces();
            if (places && places.length > 0) {
                handleSelectedPlace(places[0]);
            }
        }

        // æ¸…é™¤æœå°‹åŠŸèƒ½
        function clearSearch() {
            const input = document.getElementById('search-input');
            input.value = '';
            input.focus();
            
            // å¦‚æœæœ‰ç”¨æˆ¶æ¨™è¨˜ï¼Œå°‡åœ°åœ–ä¸­å¿ƒç§»å›ç”¨æˆ¶ä½ç½®
            if (userMarker) {
                map.setCenter(userMarker.getPosition());
                map.setZoom(16);
                
                // æ›´æ–°é™„è¿‘åœè»Šå ´
                const userPos = userMarker.getPosition();
                updateNearbyParking({
                    coords: {
                        latitude: userPos.lat(),
                        longitude: userPos.lng()
                    }
                });
            }
        }

        // LIFF ä½ç½®ç²å–å‡½æ•¸
        async function getLiffLocation() {
            if (!isLiffInitialized || !liff.isInClient()) {
                return null;
            }
            
            try {
                const position = await liff.getProfile(); // é€™æ˜¯ç¤ºä¾‹ï¼Œå¯¦éš›éœ€è¦æ ¹æ“š LIFF API èª¿æ•´
                // LIFF æ²’æœ‰ç›´æ¥çš„ä½ç½® APIï¼Œé€™è£¡ä¿ç•™æ¥å£ï¼Œæœªä¾†å¯èƒ½æœƒæœ‰
                return null;
            } catch (error) {
                console.log('LIFF location not available:', error);
                return null;
            }
        }

        // çµ±ä¸€çš„ä½ç½®ç²å–å‡½æ•¸
        async function getUserLocation(loadingDiv) {
            // å„ªå…ˆå˜—è©¦ LIFF ä½ç½®æœå‹™ï¼ˆç›®å‰ LIFF æ²’æœ‰ä½ç½® APIï¼Œä½†ä¿ç•™æ¥å£ï¼‰
            const liffLocation = await getLiffLocation();
            if (liffLocation) {
                await handleLocationSuccess(liffLocation, loadingDiv);
                return;
            }

            // ä½¿ç”¨ç€è¦½å™¨ä½ç½®æœå‹™
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        await handleLocationSuccess(position, loadingDiv);
                    },
                    (error) => {
                        handleLocationError(error, loadingDiv);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5åˆ†é˜å…§çš„ä½ç½®è³‡è¨Šå¯ä»¥é‡è¤‡ä½¿ç”¨
                    }
                );
            } else {
                handleLocationError({ code: 'BROWSER_NOT_SUPPORTED' }, loadingDiv);
            }
        }

        // ä½ç½®ç²å–æˆåŠŸè™•ç†
        async function handleLocationSuccess(position, loadingDiv) {
            // ç§»é™¤è¼‰å…¥æç¤º
            loadingDiv.remove();
            
            // è¨­ç½®ç”¨æˆ¶ä½ç½®æ¨™è¨˜
            const userPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            if (userMarker) {
                userMarker.setMap(null);
            }
            userMarker = new google.maps.Marker({
                position: userPos,
                map: map,
                title: "ä½ åœ¨é€™è£¡ï¼",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#4285F4',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#ffffff',
                    scale: 12
                }
            });

            // ä»¥ç”¨æˆ¶ä½ç½®ç‚ºä¸­å¿ƒ
            map.setCenter(userPos);
            map.setZoom(16);
            
            // æ›´æ–°é™„è¿‘åœè»Šå ´
            await updateNearbyParking(position);
            
            // è¨­ç½®å®šæœŸæ›´æ–°
            setInterval(async () => {
                await updateMarkersAvailability();
            }, 180000); // æ¯3åˆ†é˜æ›´æ–°ä¸€æ¬¡
        }

        // ä½ç½®ç²å–å¤±æ•—è™•ç†
        function handleLocationError(error, loadingDiv) {
            // ç§»é™¤è¼‰å…¥æç¤º
            loadingDiv.remove();
            console.error('Error getting user location:', error);
            
            // å¦‚æœç„¡æ³•ç²å–ç”¨æˆ¶ä½ç½®ï¼Œä½¿ç”¨é è¨­ä½ç½®
            updateNearbyParking({ lat: 25.0374865, lng: 121.5647688 });
            
            // é¡¯ç¤ºéŒ¯èª¤æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = 'ç„¡æ³•ç²å–ä½ç½®ï¼Œé¡¯ç¤ºå°åŒ—å¸‚å€åœè»Šå ´';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #ff9800;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // åˆå§‹åŒ–åœ°åœ–
        async function initMap() {
            // å…ˆåˆå§‹åŒ– LIFF
            await initializeLiff();
            
            // å‰µå»ºåœ°åœ–ï¼Œå…ˆä»¥å°åŒ—å¸‚ä¸­å¿ƒç‚ºé è¨­ä¸­å¿ƒ
            map = new google.maps.Map(document.getElementById('map'), {
                clickableIcons: false, // ç¦ç”¨é è¨­åœ°æ¨™é»æ“ŠåŠŸèƒ½
                disableDefaultUI: false, // ä¿æŒé è¨­ UI æ§åˆ¶é …
                gestureHandling: 'greedy', // æ”¹å–„è§¸æ§æ‰‹å‹¢
                center: { lat: 25.0374865, lng: 121.5647688 },
                zoom: 15,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }] // éš±è—æ‰€æœ‰åœ°æ¨™æ¨™ç±¤
                    },
                    {
                        featureType: 'poi.business',
                        stylers: [{ visibility: 'off' }] // éš±è—å•†æ¥­åœ°æ¨™
                    }
                ]
            });

            // é¡¯ç¤ºè¼‰å…¥æç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.innerHTML = 'æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                z-index: 1000;
                font-size: 16px;
            `;
            document.body.appendChild(loadingDiv);

            // æª¢æŸ¥æ˜¯å¦æœ‰åˆ†äº«çš„ä½ç½®åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            const sharedLat = urlParams.get('lat');
            const sharedLng = urlParams.get('lng');
            
            if (sharedLat && sharedLng) {
                // å¦‚æœæœ‰åˆ†äº«çš„ä½ç½®ï¼Œç›´æ¥ä½¿ç”¨è©²ä½ç½®
                const sharedPosition = {
                    coords: {
                        latitude: parseFloat(sharedLat),
                        longitude: parseFloat(sharedLng)
                    }
                };
                await handleLocationSuccess(sharedPosition, loadingDiv);
                
                // é¡¯ç¤ºåˆ†äº«æç¤º
                const shareNotice = document.createElement('div');
                shareNotice.innerHTML = 'ğŸ“ é¡¯ç¤ºæœ‹å‹åˆ†äº«çš„ä½ç½®';
                shareNotice.style.cssText = `
                    position: fixed;
                    top: 70px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #00B900;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    z-index: 2000;
                    font-size: 14px;
                `;
                document.body.appendChild(shareNotice);
                setTimeout(() => shareNotice.remove(), 4000);
            } else {
                // ç²å–ç”¨æˆ¶ä½ç½®
                await getUserLocation(loadingDiv);
            }

            // ç›£è½åœ°åœ–ç¸®æ”¾äº‹ä»¶
            map.addListener('zoom_changed', debounce(() => {
                const center = map.getCenter();
                updateNearbyParking({
                    lat: center.lat(),
                    lng: center.lng()
                }, true);
            }, 500));

            // ç›£è½åœ°åœ–æ‹–æ›³äº‹ä»¶ - ä½¿ç”¨é˜²æŠ–æ©Ÿåˆ¶
            map.addListener('dragend', debounce(() => {
                const center = map.getCenter();
                updateNearbyParking({
                    lat: center.lat(),
                    lng: center.lng()
                }, false);
            }, 300));

            // ç›£è½åœ°åœ–é»æ“Šäº‹ä»¶ - é—œé–‰è³‡è¨Šè¦–çª—
            map.addListener('click', () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                    currentInfoWindow = null;
                }
            });
            // åˆå§‹åŒ–æœå°‹åŠŸèƒ½
            const input = document.getElementById('search-input');
            searchBox = new google.maps.places.SearchBox(input);

            // è¨­å®šæœå°‹ç¯„åœç‚ºå°åŒ—å¸‚
            const taipeiBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(24.9, 121.4),
                new google.maps.LatLng(25.3, 121.7)
            );
            searchBox.setBounds(taipeiBounds);

            // ç›£è½æœå°‹æ¡†çš„ Enter éµ
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSearch();
                }
            });

            // ç›£è½æœå°‹çµæœé¸æ“‡
            searchBox.addListener('places_changed', () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) {
                    return;
                }
                handleSelectedPlace(places[0]);
            });
        }

        function handleSelectedPlace(place) {
            if (!place.geometry || !place.geometry.location) {
                console.log("Returned place contains no geometry");
                return;
            }

            map.setCenter(place.geometry.location);
            map.setZoom(17);

            if (userMarker) {
                userMarker.setMap(null);
            }
            userMarker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: "æœå°‹ä½ç½®",
                icon: {
                    path: google.maps.SymbolPath.MARKER,
                    fillColor: '#FF0000',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#FFFFFF',
                    scale: 15
                }
            });

            const searchLocation = {
                coords: {
                    latitude: place.geometry.location.lat(),
                    longitude: place.geometry.location.lng()
                }
            };
            updateNearbyParking(searchLocation, false);
        }

        function handleLocationError(error) {
            let errorMessage;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "è«‹å…è¨±ç¶²ç«™å­˜å–ä½ç½®è³‡è¨Šã€‚";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "ä½ç½®è³‡è¨Šä¸å¯ç”¨ã€‚";
                    break;
                case error.TIMEOUT:
                    errorMessage = "è«‹æ±‚ä½ç½®è³‡è¨Šè¶…æ™‚ã€‚";
                    break;
                case 'BROWSER_NOT_SUPPORTED':
                    errorMessage = "ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚";
                    break;
                default:
                    errorMessage = "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚";
            }
            alert(errorMessage);
        }

        // Load the API key with improved error handling
        async function loadGoogleMapsAPI() {
            try {
                // Try Netlify function first
                const response = await fetch("/.netlify/functions/get-maps-key");
                if (response.ok) {
                    const data = await response.json();
                    if (data.key) {
                        return data.key;
                    }
                }
                throw new Error("Netlify function failed");
            } catch (error) {
                console.log("Netlify function not available, using local config:", error);
                // Fallback to local config
                if (typeof config !== "undefined" && config.GOOGLE_MAPS_API_KEY) {
                    return config.GOOGLE_MAPS_API_KEY;
                }
                throw new Error("No API key available");
            }
        }

        // Initialize Google Maps
        loadGoogleMapsAPI()
            .then(apiKey => {
                console.log("Using API key:", apiKey ? "Found" : "Not found");
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
                script.async = true;
                script.defer = true;
                script.onerror = function() {
                    console.error("Failed to load Google Maps script");
                    alert("ç„¡æ³•è¼‰å…¥åœ°åœ–ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢");
                };
                document.body.appendChild(script);
            })
            .catch(error => {
                console.error("Error loading API key:", error);
                alert("ç„¡æ³•è¼‰å…¥åœ°åœ–è¨­å®šï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–è¯çµ¡ç®¡ç†å“¡");
            });    </script>
    <!-- Local development config -->
    <script src="config.js"></script>
</body>
</html> 