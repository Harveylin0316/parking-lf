<!DOCTYPE html>
<html>
<head>
    <title>附近停車場資訊</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        body {
            margin: 0;
            padding: 0;
        }
        .search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 80%;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #search-input {
            width: calc(100% - 20px);
            padding: 12px 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }
        .info-window {
            padding: 10px;
            max-width: 300px;
        }
        .info-window h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .info-window p {
            margin: 5px 0;
            color: #666;
        }
        .available {
            color: #4CAF50;
            font-weight: bold;
        }
        .full {
            color: #f44336;
            font-weight: bold;
        }
        .parking-list {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .parking-list.open {
            max-height: 50vh;
            overflow-y: auto;
        }
        .list-toggle {
            display: none; /* 隱藏原有按鈕 */
        }
        .my-location-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .my-location-button:hover {
            background: #f5f5f5;
        }
        .my-location-button img {
            width: 24px;
            height: 24px;
        }
        .parking-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .parking-item:last-child {
            border-bottom: none;
        }
        .parking-item h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .parking-item p {
            margin: 3px 0;
            color: #666;
            font-size: 14px;
        }
        .marker-label {
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="搜尋地點...">
    </div>
    <div id="map"></div>
    <button class="list-toggle" onclick="toggleParkingList()">顯示最近停車場</button>
    <button class="my-location-button" onclick="goToMyLocation()" title="回到我的位置">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMTIgOGMtMi4yMSAwLTQgMS43OS00IDRzMS43OSA0IDQgNCA0LTEuNzkgNC00LTEuNzktNC00LTR6bTguOTQgM2MtLjQ2LTQuMTctMy43Ny03LjQ4LTcuOTQtNy45NFYxaC0ydjIuMDZDNi44MyAzLjUyIDMuNTIgNi44MyAzLjA2IDExSDFWMTNoMi4wNmMuNDYgNC4xNyAzLjc3IDcuNDggNy45NCA3Ljk0VjIzaDJ2LTIuMDZjNC4xNy0uNDYgNy40OC0zLjc3IDcuOTQtNy45NEgyM3YtMmgtMi4wNnpNMTIgMTljLTMuODcgMC03LTMuMTMtNy03czMuMTMtNyA3LTcgNyAzLjEzIDcgNy0zLjEzIDctNyA3eiIvPjwvc3ZnPg==" alt="定位圖標">
    </button>
    <div id="parking-list" class="parking-list">
        <div id="parking-items"></div>
    </div>

    <script>
        let map;
        let userMarker;
        let parkingMarkers = [];
        let searchBox;
        const SEARCH_RADIUS = 1000; // 搜尋半徑（公尺）

        // 解析費率資訊
        function parseParkingFee(payex) {
            if (!payex) return '無資料';
            
            // 嘗試匹配 "XX元/時" 或 "每小時XX元" 的模式
            const hourlyFeeMatch = payex.match(/(\d+)元\/(小)?時|每小時(\d+)元/);
            if (hourlyFeeMatch) {
                const fee = hourlyFeeMatch[1] || hourlyFeeMatch[3];
                return `${fee}元/時`;
            }
            
            return '詳見說明';
        }

        // 計算兩點之間的距離（使用 Haversine 公式）
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球半徑（公尺）
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 清除所有停車場標記
        function clearParkingMarkers() {
            parkingMarkers.forEach(marker => marker.setMap(null));
            parkingMarkers = [];
        }

        // 顯示停車場資訊視窗
        function createInfoWindow(parkingLot, availability) {
            const availableSpaces = availability ? availability.availablecar : '無資料';
            const status = availableSpaces > 0 ? '尚有空位' : '已滿';
            const statusClass = availableSpaces > 0 ? 'available' : 'full';
            
            return `
                <div class="info-window">
                    <h3>${parkingLot.name}</h3>
                    <p>地址：${parkingLot.address}</p>
                    <p>總車位：${parkingLot.totalcar} 個</p>
                    <p>剩餘車位：<span class="${statusClass}">${availableSpaces}</span></p>
                    <p>收費：${parseParkingFee(parkingLot.payex)}</p>
                    <p>營業時間：${parkingLot.serviceTime || '24小時'}</p>
                </div>
            `;
        }

        function createMarkerLabel(parkingLot) {
            const fee = parseParkingFee(parkingLot.payex);
            return {
                text: fee,
                color: "white",
                fontSize: "12px",
                fontWeight: "bold"
            };
        }

        // 更新停車場列表
        function updateParkingList(nearbyParkingLots) {
            const listContainer = document.getElementById('parking-items');
            listContainer.innerHTML = '';

            // 只顯示最近的3個停車場
            nearbyParkingLots.slice(0, 3).forEach(lot => {
                const availableSpaces = lot.availability ? lot.availability.availablecar : '無資料';
                const statusClass = availableSpaces > 0 ? 'available' : 'full';
                
                const item = document.createElement('div');
                item.className = 'parking-item';
                item.innerHTML = `
                    <h3>${lot.parkingLot.name}</h3>
                    <p>地址：${lot.parkingLot.address}</p>
                    <p>收費：${parseParkingFee(lot.parkingLot.payex)}</p>
                    <p>剩餘車位：<span class="${statusClass}">${availableSpaces}</span></p>
                    <p>距離：${Math.round(lot.distance)}公尺</p>
                `;
                
                item.addEventListener('click', () => {
                    const position = {
                        lat: parseFloat(lot.parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod),
                        lng: parseFloat(lot.parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod)
                    };
                    map.setCenter(position);
                    map.setZoom(18);
                });
                
                listContainer.appendChild(item);
            });
        }

        function toggleParkingList() {
            const list = document.getElementById('parking-list');
            list.classList.toggle('open');
            const button = document.querySelector('.list-toggle');
            button.textContent = list.classList.contains('open') ? '隱藏停車場列表' : '顯示最近停車場';
        }

        // 更新附近的停車場標記
        async function updateNearbyParking(position) {
            try {
                // 獲取停車場資訊
                const descResponse = await fetch('TCMSV_alldesc.json');
                const descData = await descResponse.json();
                
                // 獲取即時車位資訊
                const availResponse = await fetch('TCMSV_allavailable.json');
                const availData = await availResponse.json();

                // 清除現有標記
                clearParkingMarkers();

                const userLat = position.coords ? position.coords.latitude : position.lat;
                const userLng = position.coords ? position.coords.longitude : position.lng;

                // 建立可用性查詢表
                const availabilityMap = {};
                availData.data.park.forEach(park => {
                    availabilityMap[park.id] = park;
                });

                // 儲存所有附近的停車場資訊以便排序
                const nearbyParkingLots = [];

                // 過濾並標記附近的停車場
                descData.data.park.forEach(parkingLot => {
                    // 檢查是否有座標資訊
                    if (parkingLot.EntranceCoord && 
                        parkingLot.EntranceCoord.EntrancecoordInfo && 
                        parkingLot.EntranceCoord.EntrancecoordInfo[0]) {
                        
                        const parkLat = parseFloat(parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod);
                        const parkLng = parseFloat(parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod);
                        
                        // 計算與使用者的距離
                        const distance = getDistance(userLat, userLng, parkLat, parkLng);
                        
                        // 如果在搜尋半徑內
                        if (distance <= SEARCH_RADIUS) {
                            const availability = availabilityMap[parkingLot.id];
                            const hasSpaces = availability && availability.availablecar > 0;

                            nearbyParkingLots.push({
                                parkingLot,
                                availability,
                                distance,
                                position: { lat: parkLat, lng: parkLng }
                            });
                            
                            // 創建標記
                            const marker = new google.maps.Marker({
                                position: { lat: parkLat, lng: parkLng },
                                map: map,
                                title: parkingLot.name,
                                label: createMarkerLabel(parkingLot),
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    fillColor: hasSpaces ? '#4CAF50' : '#f44336',
                                    fillOpacity: 0.9,
                                    strokeWeight: 2,
                                    strokeColor: '#ffffff',
                                    scale: 10
                                }
                            });

                            // 添加資訊視窗
                            const infoWindow = new google.maps.InfoWindow({
                                content: createInfoWindow(parkingLot, availability)
                            });

                            marker.addListener('click', () => {
                                infoWindow.open(map, marker);
                            });

                            parkingMarkers.push(marker);
                        }
                    }
                });

                // 根據距離排序停車場
                nearbyParkingLots.sort((a, b) => a.distance - b.distance);

                // 更新停車場列表
                updateParkingList(nearbyParkingLots);
            } catch (error) {
                console.error('Error fetching parking data:', error);
            }
        }

        function goToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        // 更新用戶位置標記
                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        userMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "你在這裡！",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 12
                            }
                        });

                        // 將地圖中心設為用戶位置
                        map.setCenter(pos);
                        map.setZoom(17);

                        // 更新附近停車場資訊
                        updateNearbyParking(position);
                    },
                    (error) => {
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "請允許網站存取位置資訊。";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "位置資訊不可用。";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "請求位置資訊超時。";
                                break;
                            default:
                                errorMessage = "發生未知錯誤。";
                        }
                        alert(errorMessage);
                    }
                );
            } else {
                alert("你的瀏覽器不支援地理位置功能。");
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: { lat: 25.0330, lng: 121.5654 }, // Default center (Taipei)
            });

            // 初始化搜尋框
            const input = document.getElementById('search-input');
            const searchBox = new google.maps.places.SearchBox(input);

            // 將搜尋框限制在台北市範圍
            const taipeiBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(25.0, 121.4),
                new google.maps.LatLng(25.2, 121.7)
            );
            map.setBounds(taipeiBounds);

            // 監聽搜尋結果
            searchBox.addListener('places_changed', () => {
                const places = searchBox.getPlaces();

                if (places.length === 0) {
                    return;
                }

                const place = places[0];
                if (!place.geometry || !place.geometry.location) {
                    console.log("Returned place contains no geometry");
                    return;
                }

                // 更新地圖位置
                map.setCenter(place.geometry.location);
                map.setZoom(17);

                // 更新用戶位置標記
                if (userMarker) {
                    userMarker.setMap(null);
                }
                userMarker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: "搜尋位置",
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: '#ffffff',
                        scale: 12
                    }
                });

                // 更新附近停車場
                updateNearbyParking(place.geometry.location);
            });

            // 立即請求用戶位置
            goToMyLocation();
        }

        // Load the API key
        fetch('/.netlify/functions/get-maps-key')
            .then(response => response.text())
            .then(apiKey => {
                // Load Google Maps API with the key
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.body.appendChild(script);
            })
            .catch(error => {
                console.error('Error loading API key:', error);
                // Fallback to local development
                if (typeof config !== 'undefined' && config.GOOGLE_MAPS_API_KEY) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${config.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.body.appendChild(script);
                }
            });
    </script>
    <!-- Local development config -->
    <script src="config.js"></script>
</body>
</html> 