<!DOCTYPE html>
<html>
<head>
    <title>附近停車場資訊</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
        /* ... existing styles ... */
        .navigation-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #E6000B;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            border-radius: 4px;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .navigation-button:hover {
            background-color: #cc0009;
        }

        .navigation-button img {
            width: 20px;
            height: 20px;
        }

        .info-window {
            padding: 12px;
            max-width: 300px;
        }

        .info-window-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .info-window-header h3 {
            margin: 0;
            padding-right: 8px;
            font-size: 16px;
            font-weight: bold;
        }

        .info-window p {
            margin: 4px 0;
            font-size: 14px;
        }

        .gm-ui-hover-effect {
            top: 0 !important;
            right: 0 !important;
        }

        .gm-style-iw {
            padding: 0 !important;
        }

        .gm-style-iw-d {
            overflow: hidden !important;
        }

        .gm-style-iw-c {
            padding: 0 !important;
        }
        /* ... rest of the styles ... */
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="你想去哪裡？">
        <button class="search-button" onclick="handleSearch()">搜尋</button>
    </div>
    <div id="map"></div>
    <button class="list-toggle" onclick="toggleParkingList()">顯示最近停車場</button>
    <button class="my-location-button" onclick="goToMyLocation()" title="回到我的位置">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMTIgOGMtMi4yMSAwLTQgMS43OS00IDRzMS43OSA0IDQgNCA0LTEuNzkgNC00LTEuNzktNC00LTR6bTguOTQgM2MtLjQ2LTQuMTctMy43Ny03LjQ4LTcuOTQtNy45NFYxaC0ydjIuMDZDNi44MyAzLjUyIDMuNTIgNi44MyAzLjA2IDExSDFWMTNoMi4wNmMuNDYgNC4xNyAzLjc3IDcuNDggNy45NCA3Ljk0VjIzaDJ2LTIuMDZjNC4xNy0uNDYgNy40OC0zLjc3IDcuOTQtNy45NEgyM3YtMmgtMi4wNnpNMTIgMTljLTMuODcgMC03LTMuMTMtNy03czMuMTMtNyA3LTcgNyAzLjEzIDcgNy0zLjEzIDctNyA3eiIvPjwvc3ZnPg==" alt="定位圖標">
    </button>
    <div id="parking-list" class="parking-list">
        <div id="parking-items"></div>
    </div>

    <script>
        let map;
        let userMarker;
        let parkingMarkers = [];
        let searchBox;
        let currentInfoWindow = null;
        let updateInterval; // 新增：用於存儲更新間隔的ID
        const SEARCH_RADIUS = 1000;
        const MAX_SEARCH_RADIUS = 5000;
        const MIN_VISIBLE_PARKING_LOTS = 3;
        let lastUpdatePosition = null;
        const MIN_UPDATE_DISTANCE = 200;
        let updateTimeout = null;

        // 解析費率資訊
        function parseParkingFee(payex) {
            if (!payex) return '$0';
            
            // 嘗試匹配 "XX元/時" 或 "每小時XX元" 的模式
            const hourlyFeeMatch = payex.match(/(\d+)元\/(小)?時|每小時(\d+)元/);
            if (hourlyFeeMatch) {
                const fee = hourlyFeeMatch[1] || hourlyFeeMatch[3];
                return `$${fee}`;
            }
            
            return '$0';
        }

        // 計算兩點之間的距離（使用 Haversine 公式）
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球半徑（公尺）
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 清除所有停車場標記
        function clearParkingMarkers() {
            parkingMarkers.forEach(marker => marker.setMap(null));
            parkingMarkers = [];
        }

        // 開啟導航
        function startNavigation(lat, lng, name) {
            const destination = `${lat},${lng}`;
            
            // 檢測設備類型
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // iOS 設備：使用 comgooglemaps:// scheme
                const iosUrl = `comgooglemaps://?daddr=${destination}&directionsmode=driving`;
                const webUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
                
                // 嘗試打開 Google Maps App
                window.location.href = iosUrl;
                
                // 如果 2 秒後還在同一頁面，說明沒有安裝 Google Maps，則打開網頁版
                setTimeout(() => {
                    if (document.hidden !== true) {
                        window.location.href = webUrl;
                    }
                }, 2000);
            } else if (/Android/i.test(navigator.userAgent)) {
                // Android 設備：使用 google.navigation: scheme
                const androidUrl = `google.navigation:q=${destination}&mode=d`;
                const webUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
                
                // 嘗試打開 Google Maps App
                window.location.href = androidUrl;
                
                // 如果 2 秒後還在同一頁面，說明沒有安裝 Google Maps，則打開網頁版
                setTimeout(() => {
                    if (document.hidden !== true) {
                        window.location.href = webUrl;
                    }
                }, 2000);
            } else {
                // 桌面設備：在新窗口打開網頁版地圖
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`, '_blank');
            }
        }

        // 更新停車場資訊視窗內容
        function createInfoWindow(parkingLot, availability) {
            const availableSpaces = availability ? availability.availablecar : '0';
            const status = availableSpaces > 0 ? '尚有空位' : '已滿';
            const statusClass = availableSpaces > 0 ? 'available' : 'full';
            const lat = parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod;
            const lng = parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod;
            
            const content = document.createElement('div');
            content.className = 'info-window';
            content.innerHTML = `
                <div class="info-window-header">
                    <h3>${parkingLot.name}</h3>
                </div>
                <p>地址：${parkingLot.address}</p>
                <p>總車位：${parkingLot.totalcar} 個</p>
                <p>剩餘車位：<span class="${statusClass}">${availableSpaces}</span></p>
                <p>收費：${parseParkingFee(parkingLot.payex)}</p>
                <p>營業時間：${parkingLot.serviceTime || '24小時'}</p>
                <button class="navigation-button">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMjEuNzEgMTEuMjlsLTktOS4wNzJjLS4zOS0uMzktMS4wMi0uMzktMS40MSAwbC05IDkuMDcyYy0uMzkuMzktLjM5IDEuMDIgMCAxLjQxbDkgOS4wNzFjLjM5LjM5IDEuMDIuMzkgMS40MSAwbDktOS4wNzFjLjM5LS4zOS4zOS0xLjAyIDAtMS40MXpNMTQgMTQuNThWMTJoLTR2M0g4di02aDZ2LTIuNThsNC41OSA0LjU5TDE0IDE0LjU4eiIvPjwvc3ZnPg==" alt="導航圖標">
                    開始導航
                </button>
            `;

            // 添加導航按鈕點擊事件
            const navButton = content.querySelector('.navigation-button');
            navButton.addEventListener('click', () => startNavigation(lat, lng, parkingLot.name));

            return content;
        }

        function createMarkerLabel(parkingLot) {
            const fee = parseParkingFee(parkingLot.payex);
            return {
                text: fee,
                color: "white",
                fontSize: "14px",
                fontWeight: "bold"
            };
        }

        // 更新停車場列表
        function updateParkingList(nearbyParkingLots) {
            const listContainer = document.getElementById('parking-items');
            listContainer.innerHTML = '';

            // 只顯示最近的3個停車場
            nearbyParkingLots.slice(0, 3).forEach(lot => {
                const availableSpaces = lot.availability ? lot.availability.availablecar : '0';
                const statusClass = availableSpaces > 0 ? 'available' : 'full';
                
                const item = document.createElement('div');
                item.className = 'parking-item';
                item.innerHTML = `
                    <h3>${lot.parkingLot.name}</h3>
                    <p>地址：${lot.parkingLot.address}</p>
                    <p>收費：${parseParkingFee(lot.parkingLot.payex)}</p>
                    <p>剩餘車位：<span class="${statusClass}">${availableSpaces}</span></p>
                    <p>距離：${Math.round(lot.distance)}公尺</p>
                `;
                
                item.addEventListener('click', () => {
                    const position = {
                        lat: parseFloat(lot.parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod),
                        lng: parseFloat(lot.parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod)
                    };
                    map.setCenter(position);
                    map.setZoom(18);
                });
                
                listContainer.appendChild(item);
            });
        }

        function toggleParkingList() {
            const list = document.getElementById('parking-list');
            list.classList.toggle('open');
            const button = document.querySelector('.list-toggle');
            button.textContent = list.classList.contains('open') ? '隱藏停車場列表' : '顯示最近停車場';
        }

        // 計算最佳縮放級別和搜尋半徑
        function calculateOptimalZoomAndRadius(position, parkingLots, isUserZoom = false) {
            let currentRadius = SEARCH_RADIUS;
            let nearbyLots = [];
            const userLat = position.coords ? position.coords.latitude : position.lat;
            const userLng = position.coords ? position.coords.longitude : position.lng;

            // 如果是用戶手動縮放，使用當前的縮放級別
            const currentZoom = map.getZoom();
            
            // 根據縮放級別計算搜尋半徑（不論是否為用戶縮放）
            currentRadius = Math.max(500, 5000 / Math.pow(2, currentZoom - 11));
            
            nearbyLots = parkingLots.filter(lot => {
                if (!lot.EntranceCoord?.EntrancecoordInfo?.[0]) return false;
                const parkLat = parseFloat(lot.EntranceCoord.EntrancecoordInfo[0].Xcod);
                const parkLng = parseFloat(lot.EntranceCoord.EntrancecoordInfo[0].Ycod);
                const distance = getDistance(userLat, userLng, parkLat, parkLng);
                return distance <= currentRadius;
            });

            // 如果找不到停車場，逐步增加搜尋半徑
            if (nearbyLots.length === 0) {
                while (currentRadius <= MAX_SEARCH_RADIUS) {
                    currentRadius += 500;
                    nearbyLots = parkingLots.filter(lot => {
                        if (!lot.EntranceCoord?.EntrancecoordInfo?.[0]) return false;
                        const parkLat = parseFloat(lot.EntranceCoord.EntrancecoordInfo[0].Xcod);
                        const parkLng = parseFloat(lot.EntranceCoord.EntrancecoordInfo[0].Ycod);
                        const distance = getDistance(userLat, userLng, parkLat, parkLng);
                        return distance <= currentRadius;
                    });
                    
                    if (nearbyLots.length > 0) break;
                }
            }

            return {
                zoom: currentZoom,
                radius: currentRadius,
                nearbyLots
            };
        }

        // 檢查是否需要更新
        function shouldUpdate(newPosition) {
            if (!lastUpdatePosition) return true;
            
            const distance = getDistance(
                lastUpdatePosition.lat,
                lastUpdatePosition.lng,
                newPosition.lat,
                newPosition.lng
            );
            
            return distance >= MIN_UPDATE_DISTANCE;
        }

        // 防抖函數
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(updateTimeout);
                    func(...args);
                };
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(later, wait);
            };
        }

        // 包裝更新函數
        const debouncedUpdate = debounce((position) => {
            if (shouldUpdate(position)) {
                lastUpdatePosition = position;
                updateNearbyParking(position, false);
            }
        }, 500);

        // 新增：只獲取可用性數據的函數
        async function fetchAvailabilityData() {
            try {
                const availResponse = await fetch('TCMSV_allavailable.json');
                const availData = await availResponse.json();
                return availData;
            } catch (error) {
                console.error('Error fetching availability data:', error);
                return null;
            }
        }

        // 新增：更新標記可用性的函數
        async function updateMarkersAvailability() {
            const availData = await fetchAvailabilityData();
            if (!availData) return;

            // 建立可用性查詢表
            const availabilityMap = {};
            availData.data.park.forEach(park => {
                availabilityMap[park.id] = park;
            });

            // 更新每個現有標記
            parkingMarkers.forEach(marker => {
                const parkingLot = marker.parkingLot;
                const availability = availabilityMap[parkingLot.id];
                const hasSpaces = availability && availability.availablecar > 0;

                // 更新標記圖標
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: hasSpaces ? '#4CAF50' : '#f44336',
                    fillOpacity: 0.9,
                    strokeWeight: 2,
                    strokeColor: '#ffffff',
                    scale: 20
                });

                // 如果資訊視窗是打開的，更新其內容
                if (currentInfoWindow && currentInfoWindow.anchor === marker) {
                    currentInfoWindow.setContent(createInfoWindow(parkingLot, availability));
                }
            });

            // 如果停車場列表是可見的，更新列表
            if (document.getElementById('parking-list').classList.contains('open')) {
                const center = map.getCenter();
                const position = {
                    lat: center.lat(),
                    lng: center.lng()
                };
                updateNearbyParking(position, false);
            }
        }

        // 修改：更新附近停車場函數
        async function updateNearbyParking(position, isUserZoom = false) {
            try {
                const descResponse = await fetch('TCMSV_alldesc.json');
                const descData = await descResponse.json();
                
                const availResponse = await fetch('TCMSV_allavailable.json');
                const availData = await availResponse.json();

                clearParkingMarkers();

                const userLat = position.coords ? position.coords.latitude : position.lat;
                const userLng = position.coords ? position.coords.longitude : position.lng;

                const { zoom, radius, nearbyLots } = calculateOptimalZoomAndRadius(position, descData.data.park, isUserZoom);

                // 只在非用戶縮放且找不到停車場時調整縮放級別
                if (!isUserZoom && nearbyLots.length === 0) {
                    map.setZoom(Math.max(map.getZoom() - 1, 11));
                }

                const availabilityMap = {};
                availData.data.park.forEach(park => {
                    availabilityMap[park.id] = park;
                });

                const nearbyParkingLots = [];

                nearbyLots.forEach(parkingLot => {
                    if (!parkingLot.EntranceCoord?.EntrancecoordInfo?.[0]) return;
                    
                    const parkLat = parseFloat(parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod);
                    const parkLng = parseFloat(parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod);
                    
                    const distance = getDistance(userLat, userLng, parkLat, parkLng);
                    
                    const availability = availabilityMap[parkingLot.id];
                    const hasSpaces = availability && availability.availablecar > 0;

                    nearbyParkingLots.push({
                        parkingLot,
                        availability,
                        distance,
                        position: { lat: parkLat, lng: parkLng }
                    });
                    
                    const marker = new google.maps.Marker({
                        position: { lat: parkLat, lng: parkLng },
                        map: map,
                        title: parkingLot.name,
                        label: {
                            text: parseParkingFee(parkingLot.payex),
                            color: "white",
                            fontSize: "16px",
                            fontWeight: "bold"
                        },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: hasSpaces ? '#4CAF50' : '#f44336',
                            fillOpacity: 0.9,
                            strokeWeight: 2,
                            strokeColor: '#ffffff',
                            scale: 20
                        }
                    });

                    marker.parkingLot = parkingLot;

                    const infoWindow = new google.maps.InfoWindow({
                        content: createInfoWindow(parkingLot, availability),
                        maxWidth: 300,
                        pixelOffset: new google.maps.Size(0, -10)
                    });

                    marker.addListener('click', (e) => {
                        e.stop();
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    });

                    parkingMarkers.push(marker);
                });

                nearbyParkingLots.sort((a, b) => a.distance - b.distance);
                updateParkingList(nearbyParkingLots);

                // 只在真的找不到停車場時才顯示提示
                if (nearbyParkingLots.length === 0 && radius >= MAX_SEARCH_RADIUS) {
                    alert('附近沒有停車場，已擴大搜尋範圍');
                }
            } catch (error) {
                console.error('Error fetching parking data:', error);
            }
        }

        function goToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        userMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "你在這裡！",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 12
                            }
                        });

                        map.setCenter(pos);
                        map.setZoom(17);

                        updateNearbyParking(position, false);
                    },
                    (error) => {
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                handleLocationError({ code: 'BROWSER_NOT_SUPPORTED' });
            }
        }

        function handleSearch() {
            const input = document.getElementById('search-input');
            const places = searchBox.getPlaces();
            if (places && places.length > 0) {
                handleSelectedPlace(places[0]);
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: { lat: 25.0330, lng: 121.5654 },
                gestureHandling: 'greedy',
                mapTypeControl: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                fullscreenControl: false,
                streetViewControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                },
                clickableIcons: false,
                styles: [
                    {
                        featureType: "administrative",
                        elementType: "geometry",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            const mapDiv = document.getElementById('map');
            const style = document.createElement('style');
            style.type = 'text/css';
            style.innerHTML = `
                .gmnoprint, .gm-style-cc, .gmnoscreen {
                    display: none !important;
                }
                .gm-style a[href^="https://maps.google.com/maps"] {
                    display: none !important;
                }
            `;
            document.getElementsByTagName('head')[0].appendChild(style);

            map.addListener('click', () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                    currentInfoWindow = null;
                }
            });

            // 使用一個變數追踪是否正在更新
            let isUpdating = false;
            
            // 修改拖曳結束事件處理
            map.addListener('dragend', () => {
                if (isUpdating) return;
                isUpdating = true;
                
                const center = map.getCenter();
                const position = {
                    lat: center.lat(),
                    lng: center.lng()
                };
                
                updateNearbyParking(position, false).finally(() => {
                    isUpdating = false;
                });
            });

            // 修改縮放事件處理
            let zoomTimer;
            map.addListener('zoom_changed', () => {
                if (isUpdating) return;
                clearTimeout(zoomTimer);
                
                zoomTimer = setTimeout(() => {
                    isUpdating = true;
                    const center = map.getCenter();
                    const position = {
                        lat: center.lat(),
                        lng: center.lng()
                    };
                    updateNearbyParking(position, true).finally(() => {
                        isUpdating = false;
                    });
                }, 500);
            });

            const input = document.getElementById('search-input');
            searchBox = new google.maps.places.SearchBox(input);

            const taipeiBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(25.0, 121.4),
                new google.maps.LatLng(25.2, 121.7)
            );
            searchBox.setBounds(taipeiBounds);

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSearch();
                }
            });

            searchBox.addListener('places_changed', () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) {
                    return;
                }
                handleSelectedPlace(places[0]);
            });

            // 開始定期更新
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            updateInterval = setInterval(updateMarkersAvailability, 5 * 60 * 1000); // 每5分鐘更新一次

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        userMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "你在這裡！",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 12
                            }
                        });

                        map.setCenter(pos);
                        map.setZoom(17);

                        updateNearbyParking(position, false);
                    },
                    (error) => {
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                handleLocationError({ code: 'BROWSER_NOT_SUPPORTED' });
            }
        }

        function handleSelectedPlace(place) {
            if (!place.geometry || !place.geometry.location) {
                console.log("Returned place contains no geometry");
                return;
            }

            map.setCenter(place.geometry.location);
            map.setZoom(17);

            if (userMarker) {
                userMarker.setMap(null);
            }
            userMarker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: "搜尋位置",
                icon: {
                    path: google.maps.SymbolPath.MARKER,
                    fillColor: '#FF0000',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#FFFFFF',
                    scale: 15
                }
            });

            const searchLocation = {
                coords: {
                    latitude: place.geometry.location.lat(),
                    longitude: place.geometry.location.lng()
                }
            };
            updateNearbyParking(searchLocation, false);
        }

        function handleLocationError(error) {
            let errorMessage;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "請允許網站存取位置資訊。";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "位置資訊不可用。";
                    break;
                case error.TIMEOUT:
                    errorMessage = "請求位置資訊超時。";
                    break;
                case 'BROWSER_NOT_SUPPORTED':
                    errorMessage = "你的瀏覽器不支援地理位置功能。";
                    break;
                default:
                    errorMessage = "發生未知錯誤。";
            }
            alert(errorMessage);
        }

        // 新增：頁面卸載時清理
        window.addEventListener('unload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });

        // Load the API key
        fetch('/.netlify/functions/get-maps-key')
            .then(response => response.text())
            .then(apiKey => {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.body.appendChild(script);
            })
            .catch(error => {
                console.error('Error loading API key:', error);
                if (typeof config !== 'undefined' && config.GOOGLE_MAPS_API_KEY) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${config.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.body.appendChild(script);
                }
            });
    </script>
    <!-- Local development config -->
    <script src="config.js"></script>
</body>
</html> 