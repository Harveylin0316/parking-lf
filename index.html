<!DOCTYPE html>
<html>
<head>
    <title>My Location on Google Maps</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let map;
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: { lat: 25.0330, lng: 121.5654 }, // Default center (Taipei)
            });

            // Request user location immediately
            getUserLocation();
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        // Create a marker for user's location
                        new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "你在這裡！"
                        });

                        // Center map on user's location
                        map.setCenter(pos);
                    },
                    (error) => {
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "請允許網站存取位置資訊。";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "位置資訊不可用。";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "請求位置資訊超時。";
                                break;
                            default:
                                errorMessage = "發生未知錯誤。";
                        }
                        alert(errorMessage);
                    }
                );
            } else {
                alert("你的瀏覽器不支援地理位置功能。");
            }
        }

        // Load the API key
        fetch('/.netlify/functions/get-maps-key')
            .then(response => response.text())
            .then(apiKey => {
                // Load Google Maps API with the key
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.body.appendChild(script);
            })
            .catch(error => {
                console.error('Error loading API key:', error);
                // Fallback to local development
                if (typeof config !== 'undefined' && config.GOOGLE_MAPS_API_KEY) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${config.GOOGLE_MAPS_API_KEY}&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.body.appendChild(script);
                }
            });
    </script>
    <!-- Local development config -->
    <script src="config.js"></script>
</body>
</html> 