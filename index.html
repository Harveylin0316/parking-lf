<!DOCTYPE html>
<html>
<head>
    <title>附近停車場資訊</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="你想去哪裡？">
        <button class="search-button" onclick="handleSearch()">搜尋</button>
    </div>
    <div id="map"></div>
    <button class="list-toggle" onclick="toggleParkingList()">顯示最近停車場</button>
    <button class="my-location-button" onclick="goToMyLocation()" title="回到我的位置">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMTIgOGMtMi4yMSAwLTQgMS43OS00IDRzMS43OSA0IDQgNCA0LTEuNzkgNC00LTEuNzktNC00LTR6bTguOTQgM2MtLjQ2LTQuMTctMy43Ny03LjQ4LTcuOTQtNy45NFYxaC0ydjIuMDZDNi44MyAzLjUyIDMuNTIgNi44MyAzLjA2IDExSDFWMTNoMi4wNmMuNDYgNC4xNyAzLjc3IDcuNDggNy45NCA3Ljk0VjIzaDJ2LTIuMDZjNC4xNy0uNDYgNy40OC0zLjc3IDcuOTQtNy45NEgyM3YtMmgtMi4wNnpNMTIgMTljLTMuODcgMC03LTMuMTMtNy03czMuMTMtNyA3LTcgNyAzLjEzIDcgNy0zLjEzIDctNyA3eiIvPjwvc3ZnPg==" alt="定位圖標">
    </button>
    <div id="parking-list" class="parking-list">
        <div id="parking-items"></div>
    </div>

    <script>
        let map;
        let userMarker;
        let parkingMarkers = [];
        let searchBox;
        let currentInfoWindow = null; // 追踪當前打開的資訊視窗
        const SEARCH_RADIUS = 1000; // 初始搜尋半徑（公尺）
        const MAX_SEARCH_RADIUS = 5000; // 最大搜尋半徑（公尺）
        const MIN_VISIBLE_PARKING_LOTS = 3; // 最少要顯示的停車場數量

        // 解析費率資訊
        function parseParkingFee(payex) {
            if (!payex) return '$0';
            
            // 嘗試匹配 "XX元/時" 或 "每小時XX元" 的模式
            const hourlyFeeMatch = payex.match(/(\d+)元\/(小)?時|每小時(\d+)元/);
            if (hourlyFeeMatch) {
                const fee = hourlyFeeMatch[1] || hourlyFeeMatch[3];
                return `$${fee}`;
            }
            
            return '$0';
        }

        // 計算兩點之間的距離（使用 Haversine 公式）
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球半徑（公尺）
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 清除所有停車場標記
        function clearParkingMarkers() {
            parkingMarkers.forEach(marker => marker.setMap(null));
            parkingMarkers = [];
        }

        // 開啟導航
        function startNavigation(lat, lng, name) {
            const destination = `${lat},${lng}`;
            const mapsUrl = `google.maps://dir/?api=1&destination=${destination}&travelmode=driving&dir_action=navigate`;
            const webUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
            
            // 創建一個隱藏的 iframe
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // 檢測設備類型
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                // 移動設備：嘗試打開 Google Maps 應用
                iframe.src = mapsUrl;
                
                // 移除 iframe
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 100);
            } else {
                // 桌面設備：在新窗口打開網頁版地圖
                window.open(webUrl, '_blank');
            }
        }

        // 更新停車場資訊視窗內容
        function createInfoWindow(parkingLot, availability) {
            const availableSpaces = availability ? availability.availablecar : '無資料';
            const status = availableSpaces > 0 ? '尚有空位' : '已滿';
            const statusClass = availableSpaces > 0 ? 'available' : 'full';
            const lat = parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod;
            const lng = parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod;
            
            const content = document.createElement('div');
            content.className = 'info-window';
            content.innerHTML = `
                <h3>${parkingLot.name}</h3>
                <p>地址：${parkingLot.address}</p>
                <p>總車位：${parkingLot.totalcar} 個</p>
                <p>剩餘車位：<span class="${statusClass}">${availableSpaces}</span></p>
                <p>收費：${parseParkingFee(parkingLot.payex)}</p>
                <p>營業時間：${parkingLot.serviceTime || '24小時'}</p>
                <button class="navigation-button">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMjEuNzEgMTEuMjlsLTktOS4wNzJjLS4zOS0uMzktMS4wMi0uMzktMS40MSAwbC05IDkuMDcyYy0uMzkuMzktLjM5IDEuMDIgMCAxLjQxbDkgOS4wNzFjLjM5LjM5IDEuMDIuMzkgMS40MSAwbDktOS4wNzFjLjM5LS4zOS4zOS0xLjAyIDAtMS40MXpNMTQgMTQuNThWMTJoLTR2M0g4di02aDZ2LTIuNThsNC41OSA0LjU5TDE0IDE0LjU4eiIvPjwvc3ZnPg==" alt="導航圖標">
                    開始導航
                </button>
            `;

            // 添加導航按鈕點擊事件
            const navButton = content.querySelector('.navigation-button');
            navButton.addEventListener('click', () => startNavigation(lat, lng, parkingLot.name));

            return content;
        }

        function createMarkerLabel(parkingLot) {
            const fee = parseParkingFee(parkingLot.payex);
            return {
                text: fee,
                color: "white",
                fontSize: "14px",
                fontWeight: "bold"
            };
        }

        // 更新停車場列表
        function updateParkingList(nearbyParkingLots) {
            const listContainer = document.getElementById('parking-items');
            listContainer.innerHTML = '';

            // 只顯示最近的3個停車場
            nearbyParkingLots.slice(0, 3).forEach(lot => {
                const availableSpaces = lot.availability ? lot.availability.availablecar : '無資料';
                const statusClass = availableSpaces > 0 ? 'available' : 'full';
                
                const item = document.createElement('div');
                item.className = 'parking-item';
                item.innerHTML = `
                    <h3>${lot.parkingLot.name}</h3>
                    <p>地址：${lot.parkingLot.address}</p>
                    <p>收費：${parseParkingFee(lot.parkingLot.payex)}</p>
                    <p>剩餘車位：<span class="${statusClass}">${availableSpaces}</span></p>
                    <p>距離：${Math.round(lot.distance)}公尺</p>
                `;
                
                item.addEventListener('click', () => {
                    const position = {
                        lat: parseFloat(lot.parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod),
                        lng: parseFloat(lot.parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod)
                    };
                    map.setCenter(position);
                    map.setZoom(18);
                });
                
                listContainer.appendChild(item);
            });
        }

        function toggleParkingList() {
            const list = document.getElementById('parking-list');
            list.classList.toggle('open');
            const button = document.querySelector('.list-toggle');
            button.textContent = list.classList.contains('open') ? '隱藏停車場列表' : '顯示最近停車場';
        }

        // 計算最佳縮放級別和搜尋半徑
        function calculateOptimalZoomAndRadius(position, parkingLots) {
            let currentRadius = SEARCH_RADIUS;
            let nearbyLots = [];
            const userLat = position.coords ? position.coords.latitude : position.lat;
            const userLng = position.coords ? position.coords.longitude : position.lng;

            // 逐步增加搜尋半徑直到找到足夠的停車場
            while (currentRadius <= MAX_SEARCH_RADIUS) {
                nearbyLots = parkingLots.filter(lot => {
                    if (!lot.EntranceCoord?.EntrancecoordInfo?.[0]) return false;
                    const parkLat = parseFloat(lot.EntranceCoord.EntrancecoordInfo[0].Xcod);
                    const parkLng = parseFloat(lot.EntranceCoord.EntrancecoordInfo[0].Ycod);
                    const distance = getDistance(userLat, userLng, parkLat, parkLng);
                    return distance <= currentRadius;
                });

                if (nearbyLots.length >= MIN_VISIBLE_PARKING_LOTS) {
                    break;
                }
                currentRadius += 500; // 每次增加 500 公尺
            }

            // 計算適當的縮放級別
            // 根據搜尋半徑決定縮放級別：
            // 1000m -> zoom 15
            // 2000m -> zoom 14
            // 3000m -> zoom 13
            // 4000m -> zoom 12
            // 5000m -> zoom 11
            const zoom = Math.max(16 - Math.floor(currentRadius / 1000), 11);

            return {
                zoom,
                radius: currentRadius,
                nearbyLots
            };
        }

        // 更新附近的停車場標記
        async function updateNearbyParking(position) {
            try {
                // 獲取停車場資訊
                const descResponse = await fetch('TCMSV_alldesc.json');
                const descData = await descResponse.json();
                
                // 獲取即時車位資訊
                const availResponse = await fetch('TCMSV_allavailable.json');
                const availData = await availResponse.json();

                // 清除現有標記
                clearParkingMarkers();

                const userLat = position.coords ? position.coords.latitude : position.lat;
                const userLng = position.coords ? position.coords.longitude : position.lng;

                // 計算最佳縮放級別和搜尋半徑
                const { zoom, radius, nearbyLots } = calculateOptimalZoomAndRadius(position, descData.data.park);

                // 更新地圖縮放級別
                map.setZoom(zoom);

                // 建立可用性查詢表
                const availabilityMap = {};
                availData.data.park.forEach(park => {
                    availabilityMap[park.id] = park;
                });

                // 儲存所有附近的停車場資訊以便排序
                const nearbyParkingLots = [];

                // 過濾並標記附近的停車場
                nearbyLots.forEach(parkingLot => {
                    const parkLat = parseFloat(parkingLot.EntranceCoord.EntrancecoordInfo[0].Xcod);
                    const parkLng = parseFloat(parkingLot.EntranceCoord.EntrancecoordInfo[0].Ycod);
                    
                    // 計算與使用者的距離
                    const distance = getDistance(userLat, userLng, parkLat, parkLng);
                    
                    const availability = availabilityMap[parkingLot.id];
                    const hasSpaces = availability && availability.availablecar > 0;

                    nearbyParkingLots.push({
                        parkingLot,
                        availability,
                        distance,
                        position: { lat: parkLat, lng: parkLng }
                    });
                    
                    // 創建標記
                    const marker = new google.maps.Marker({
                        position: { lat: parkLat, lng: parkLng },
                        map: map,
                        title: parkingLot.name,
                        label: {
                            text: parseParkingFee(parkingLot.payex),
                            color: "white",
                            fontSize: "16px",
                            fontWeight: "bold"
                        },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: hasSpaces ? '#4CAF50' : '#f44336',
                            fillOpacity: 0.9,
                            strokeWeight: 2,
                            strokeColor: '#ffffff',
                            scale: 20
                        }
                    });

                    // 添加資訊視窗
                    const infoWindow = new google.maps.InfoWindow({
                        content: createInfoWindow(parkingLot, availability),
                        maxWidth: 300,
                        pixelOffset: new google.maps.Size(0, -10)
                    });

                    // 添加標記點擊事件
                    marker.addListener('click', (e) => {
                        // 阻止事件冒泡到地圖
                        e.stop();
                        
                        // 關閉之前打開的資訊視窗
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        
                        // 打開新的資訊視窗
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    });

                    parkingMarkers.push(marker);
                });

                // 根據距離排序停車場
                nearbyParkingLots.sort((a, b) => a.distance - b.distance);

                // 更新停車場列表
                updateParkingList(nearbyParkingLots);

                // 如果沒有找到任何停車場，顯示提示訊息
                if (nearbyParkingLots.length === 0) {
                    alert('附近沒有停車場，已擴大搜尋範圍');
                }
            } catch (error) {
                console.error('Error fetching parking data:', error);
            }
        }

        function goToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        // 更新用戶位置標記
                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        userMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "你在這裡！",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 12
                            }
                        });

                        // 將地圖中心設為用戶位置
                        map.setCenter(pos);
                        map.setZoom(17);

                        // 更新附近停車場資訊
                        updateNearbyParking(position);
                    },
                    (error) => {
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                handleLocationError({ code: 'BROWSER_NOT_SUPPORTED' });
            }
        }

        function handleSearch() {
            const input = document.getElementById('search-input');
            const places = searchBox.getPlaces();
            if (places && places.length > 0) {
                handleSelectedPlace(places[0]);
            }
        }

        function initMap() {
            // 先創建地圖但不設置中心點
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: { lat: 25.0330, lng: 121.5654 }, // 暫時的中心點
                gestureHandling: 'greedy', // 允許在移動設備上直接拖動地圖
                mapTypeControl: false, // 隱藏地圖類型切換按鈕
                mapTypeId: google.maps.MapTypeId.ROADMAP, // 設置預設地圖類型為一般地圖
                fullscreenControl: false, // 隱藏全螢幕控制按鈕
                streetViewControl: false, // 隱藏街景控制按鈕
                zoomControl: true, // 保留縮放控制按鈕
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                }
            });

            // 添加地圖點擊事件監聽器
            map.addListener('click', () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                    currentInfoWindow = null;
                }
            });

            // 初始化搜尋框
            const input = document.getElementById('search-input');
            const searchBox = new google.maps.places.SearchBox(input);

            // 將搜尋框限制在台北市範圍
            const taipeiBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(25.0, 121.4),
                new google.maps.LatLng(25.2, 121.7)
            );
            searchBox.setBounds(taipeiBounds);

            // 監聽搜尋框的 Enter 鍵
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSearch();
                }
            });

            // 監聽搜尋結果
            searchBox.addListener('places_changed', () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) {
                    return;
                }
                handleSelectedPlace(places[0]);
            });

            // 立即請求用戶位置並等待
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        // 更新用戶位置標記
                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        userMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "你在這裡！",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 12
                            }
                        });

                        // 將地圖中心設為用戶位置
                        map.setCenter(pos);
                        map.setZoom(17);

                        // 更新附近停車場資訊
                        updateNearbyParking(position);
                    },
                    (error) => {
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                handleLocationError({ code: 'BROWSER_NOT_SUPPORTED' });
            }
        }

        function handleSelectedPlace(place) {
            if (!place.geometry || !place.geometry.location) {
                console.log("Returned place contains no geometry");
                return;
            }

            // 更新地圖位置
            map.setCenter(place.geometry.location);
            map.setZoom(17);

            // 更新搜尋位置標記
            if (userMarker) {
                userMarker.setMap(null);
            }
            userMarker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: "搜尋位置",
                icon: {
                    path: google.maps.SymbolPath.MARKER,
                    fillColor: '#FF0000',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#FFFFFF',
                    scale: 15
                }
            });

            // 更新附近停車場
            const searchLocation = {
                coords: {
                    latitude: place.geometry.location.lat(),
                    longitude: place.geometry.location.lng()
                }
            };
            updateNearbyParking(searchLocation);
        }

        function handleLocationError(error) {
            let errorMessage;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "請允許網站存取位置資訊。";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "位置資訊不可用。";
                    break;
                case error.TIMEOUT:
                    errorMessage = "請求位置資訊超時。";
                    break;
                case 'BROWSER_NOT_SUPPORTED':
                    errorMessage = "你的瀏覽器不支援地理位置功能。";
                    break;
                default:
                    errorMessage = "發生未知錯誤。";
            }
            alert(errorMessage);
        }

        // Load the API key
        fetch('/.netlify/functions/get-maps-key')
            .then(response => response.text())
            .then(apiKey => {
                // Load Google Maps API with the key
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.body.appendChild(script);
            })
            .catch(error => {
                console.error('Error loading API key:', error);
                // Fallback to local development
                if (typeof config !== 'undefined' && config.GOOGLE_MAPS_API_KEY) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${config.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.body.appendChild(script);
                }
            });
    </script>
    <!-- Local development config -->
    <script src="config.js"></script>
</body>
</html> 